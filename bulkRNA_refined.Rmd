---
title: "R Notebook"
output: html_notebook
---

```{r}
library(DESeq2)
library(dplyr)
library(ggplot2)
library(pheatmap)
library("RColorBrewer")
library(clusterProfiler)
library(biomaRt)
library(org.Hs.eg.db)
library(gprofiler2)
library(ggsci)
library(ggfortify)
library(ComplexHeatmap)
library(paletteer)
library(dendextend)
library(EnhancedVolcano)
library(ggbreak)
library(EnsDb.Hsapiens.v86)
library(circlize)
library(ggpubr)
library(ArchR)

```

#read in count files
```{r}
directory <- "../Counts/"
files <- list.files(directory, full.names = T)

datalist = lapply(files, function(x){read.csv(file=x,sep = "\t", header=F, col.names = c("geneID", substr(x, 19, 21)))})
#datalist[2]
combined <- Reduce(function(x,y) {merge(x,y, by = "geneID")}, datalist)
head(combined)

```

#prepare files according to DESeq2 guidelines
```{r}
samples <- substr(files, 18, 20)
samples
sampleCondition <- c( "Naive", "Naive", "Naive", "Naive", "Naive", "Naive", "Naive", "Naive", "Naive", "Naive",
                                         "TSCM", "TSCM", "TSCM", "TSCM", "TSCM", "TSCM", "TSCM", "TSCM", "TSCM", "TSCM",
                                         "Precursors", "Precursors", "Precursors", "Precursors", "Precursors", "Precursors", "Precursors", "Precursors", "Precursors", "Precursors", 
                                         "Effectors", "Effectors", "Effectors", "Effectors", "Effectors", "Effectors", "Effectors", "Effectors", "Effectors", "Effectors", 
                      "TCM", "TCM", "TCM", "TCM", "TCM", "TCM", "TCM", "TCM",
"TCM", "TCM", "TEM", "TEM", "TEM", "TEM", "TEM", "TEM", "TEM", "TEM", "TEM", "TEM", 
"CD8_TEMRA", "CD8_TEMRA", "CD8_TEMRA", "CD8_TEMRA", "CD8_TEMRA", "CD8_TEMRA", "CD8_TEMRA", "CD8_TEMRA", "CD8_TEMRA", "CD8_TEMRA" )
sampleCondition

donorid <- c("D10", "D1", "D2", "D3", "D4", "D5", "D6", "D7", "D8", "D9")

donorid[rep(seq(1:10),times=7)] -> donorid

sampleTable <- data.frame(sampleName = c("D10_Naive", "D1_Naive", "D2_Naive", "D3_Naive", "D4_Naive", "D5_Naive", "D6_Naive", "D7_Naive", "D8_Naive", "D9_Naive",
                                         "D10_TSCM", "D1_TSCM", "D2_TSCM", "D3_TSCM", "D4_TSCM", "D5_TSCM", "D6_TSCM", "D7_TSCM", "D8_TSCM", "D9_TSCM",
                                         "D10_Precursors", "D1_Precursors", "D2_Precursors", "D3_Precursors", "D4_Precursors", "D5_Precursors", "D6_Precursors", "D7_Precursors", "D8_Precursors", "D9_Precursors", 
                                         "D10_Effectors", "D1_Effectors", "D2_Effectors", "D3_Effectors", "D4_Effectors", "D5_Effectors", "D6_Effectors", "D7_Effectors", "D8_Effectors", "D9_Effectors", 
                                         "D10_TCM", "D1_TCM" ,"D2_TCM", "D3_TCM", "D4_TCM", "D5_TCM", "D6_TCM", "D7_TCM","D8_TCM", "D9_TCM", 
                                         "D10_TEM", "D1_TEM", "D2_TEM", "D3_TEM", "D4_TEM", "D5_TEM", "D6_TEM", "D7_TEM", "D8_TEM", "D9_TEM", 
                                         "D10_CD8_TEMRA", "D1_CD8_TEMRA", "D2_CD8_TEMRA", "D3_CD8_TEMRA", "D4_CD8_TEMRA", "D5_CD8_TEMRA", "D6_CD8_TEMRA", "D7_CD8_TEMRA", "D8_CD8_TEMRA", "D9_CD8_TEMRA"),
fileName = files,  condition = sampleCondition, donor = donorid)
sampleTable
```

```{r}
ddsHTSeq <- DESeqDataSetFromHTSeqCount(
    sampleTable = sampleTable,
    directory   = directory,
    design      = ~0 + condition + donor
)

genes_to_keep <- rowSums(counts(ddsHTSeq)) >= 100
sum(genes_to_keep)
```

```{r}
vsd <- vst(dds, blind=FALSE)
```

#PCA plot (Figure 1)
```{r}
plotPCA(vsd, ntop = 2000, intgroup = c("condition", "donor")) -> pca.vsd

#pca.vsd$data %>% head()
my_cols1 <- c("#7F7F7F", "#548234", "#842121", "#FFA500", "#00BFC4", "#F8766D", "#FF00FF")
names(my_cols1) <- c("Naive", "TSCM", "TCM", "TEM", "Precursors", "Effectors", "CD8_TEMRA")

pca.vsd + scale_color_manual(values = my_cols1) + theme_classic()

#if (!dir.exists("Images")) {dir.create("Images")}
IMG_OUT = "Images"
pdf(sprintf("%s/samplePCA_with8ra.pdf", IMG_OUT), width=10, height=5)
pca.vsd + scale_color_manual(values = my_cols1) + theme_classic()
dev.off()
```

#generating normalized count matrix
```{r}
run <- DESeq(dds)
normalized_counts <- counts(run, normalized = T)
head(normalized_counts)
#write.csv(normalized_counts, file = "normalized_counts.csv")

ensembl_hs = useMart(biomart='ensembl', dataset='hsapiens_gene_ensembl')
attributes_hs <- listAttributes(ensembl_hs)
filters_hs <- listFilters(ensembl_hs)

human_biotype <- getBM(attributes=c('ensembl_gene_id', 'external_gene_name', 'gene_biotype', 'description', 'entrezgene_id'), 
    #   filters = 'affy_hg_u133_plus_2', 
       values = row.names(normalized_counts), 
       mart = ensembl_hs)

dim(human_biotype)
human_biotype <- human_biotype%>% group_by(ensembl_gene_id)%>% filter(row_number()==1) #gets rid of the repeated ensembl ids

human_biotype[]

normalized_counts <- as.data.frame(normalized_counts)
row.names(normalized_counts)
normalized_counts$ensembl_gene_id <- row.names(normalized_counts)
head(normalized_counts)

normalized_counts <- merge(normalized_counts, human_biotype, 
                           by = "ensembl_gene_id", 
                           all.x = T)
length(normalized_counts$ensembl_gene_id)
head(normalized_counts)

#write.csv(normalized_counts, "normalized_counts.csv")
```

#pairwise comparisons between cell types and exporting results
```{r}
res_celltype1_celltype2 <- results(run, contrast=c("condition", "celltype1", "celltype2"))
res_celltype1_celltype2<- as.data.frame(res_celltype1_celltype2)
length(res_celltype1_celltype2)

#row.names(res_celltype1_celltype2)
res_celltype1_celltype2$ensembl_gene_id <- row.names(res_celltype1_celltype2)
head(res_celltype1_celltype2)
length(res_celltype1_celltype2[res_celltype1_celltype2$padj <= 0.05 & !is.na(res_celltype1_celltype2$padj), ]$padj)
#write.csv(res_celltype1_celltype2, "befor_MERGE.csv")
length(res_celltype1_celltype2$baseMean)

DE_celltype1_vs_celltype2 <- merge(human_biotype, res_celltype1_celltype2,
                          by = "ensembl_gene_id", all.x = F)
#write.csv(DE_celltype1_vs_celltype2, "after_merge_ensembl.csv")
#colnames(DE_celltype1_vs_celltype2)
length(DE_celltype1_vs_celltype2[DE_celltype1_vs_celltype2$padj <= 0.05 & !is.na(DE_celltype1_vs_celltype2$padj), ]$ensembl_gene_id)

DE_celltype1_vs_celltype2$DE <- ifelse(DE_celltype1_vs_celltype2$padj <= 0.05 & DE_celltype1_vs_celltype2$log2FoldChange>1, "up" ,ifelse(DE_celltype1_vs_celltype2$padj <= 0.05 & DE_celltype1_vs_celltype2$log2FoldChange<1, "down", "unchanged"))

class(DE_celltype1_vs_celltype2)
write.csv(DE_celltype1_vs_celltype2, "DE_celltype1 vs celltype2.csv")

```

#volcano plots for CD4-TEMRA vs CD8-TEMRA (Figure 1)
```{r}
read.csv("../DE_celltype1 vs celltype2.csv", header = T) -> c1vc2
```

```{r}
c1vc2 %>% dplyr::filter(!is.na(external_gene_name)) %>% dplyr::filter(padj <= 0.05) -> c1vc2
c1vc2 %>% head()

c1vc2$X <- NULL
rownames(c1vc2) <- c1vc2$ensembl_gene_id
c1vc2 %>% head()

```

```{r}
#color based on cell type
keyvals <- ifelse(
    c1vc2$log2FoldChange > 1, '#F8766D',
      ifelse(c1vc2$log2FoldChange < -1, '#FF00FF',
        'black'))
  keyvals[is.na(keyvals)] <- 'black'
  names(keyvals)[keyvals == '#F8766D'] <- 'Celltype1 Up'
  names(keyvals)[keyvals == 'black'] <- 'NS'
  names(keyvals)[keyvals == '#FF00FF'] <- 'Celltype2 Up'

EnhancedVolcano(c1vc2,
    lab = c1vc2$external_gene_name,
    x = 'log2FoldChange',
    y = 'padj',
    title = 'Celltype1 versus Celltype2',
    subtitle = NULL,
    selectLab = ifelse(c1vc2$log2FoldChange > 2 | c1vc2$log2FoldChange < -2, as.character(c1vc2$external_gene_name),''),
    #xlim = c(-0.3, 0.75),
    xlab = "Fold Change",
    axisLabSize = 10,
    colCustom = keyvals,
    pCutoff = 0.05,
    FCcutoff = 1,
    pointSize = 2.0,
    labSize = 2.5,
    cutoffLineType = 'twodash',
    cutoffLineWidth = 0.8,
    legendLabels=c('Not sig.','FoldChange','p-value',
      'p-value & FoldChange'),  
    legendPosition = 'right',
    legendLabSize = 10,
    legendIconSize = 3.0,
    drawConnectors = T,
    widthConnectors = 0.2,
    max.overlaps = 50,
    gridlines.major = F,
    gridlines.minor = F
    ) -> p1

pdf(sprintf("%s/Celltype1vCelltype2_Volcano.pdf", IMG_OUT), width=8, height=6)
p1
dev.off()
```

#naive vs effectors
```{r}
read.csv("../DE_Naive vs Eff.csv", header = T) -> nve

nve %>% dplyr::filter(!is.na(external_gene_name)) %>% dplyr::filter(padj <= 0.01 & DE == "up") %>% arrange(desc(log2FoldChange)) %>% top_n(n = 100, log2FoldChange) %>% pull(ensembl_gene_id) -> n100

nve %>% dplyr::filter(!is.na(external_gene_name)) %>% dplyr::filter(padj <= 0.01 & DE == "down") %>% arrange(log2FoldChange) %>% top_n(n = 100, abs(log2FoldChange)) %>% pull(ensembl_gene_id) -> e100

c(n100, e100) -> ne100
```

#convert ENSG id to Symbol and order them according to ne100
```{r}
geneIDs2 <- ensembldb::select(EnsDb.Hsapiens.v86, keys= ne100, keytype = "GENEID", columns = c("SYMBOL","GENEID"))

rownames(geneIDs2) <- geneIDs2$GENEID

geneIDs2[order(match(rownames(geneIDs2), ne100)), , drop = FALSE] -> geneIDs2.ordered

ne100.symbol <- geneIDs2.ordered$SYMBOL
```

#generate color scale
```{r}
col_fun_rna <- colorRamp2(c(-2, -1, 0, 1, 2), paletteContinuous(set = "horizonExtra", n=5, reverse = FALSE))
col_fun_rna(seq(-3, 3))
```

#generate top annotation for heatmaps
```{r}
colData(dds) -> metadata
th <- HeatmapAnnotation(df = colData(dds))

my_cols1 <- c("#7F7F7F", "#548234", "#842121", "#FFA500", "#00BFC4", "#F8766D", "#FF00FF")
names(my_cols1) <- c("Naive", "TSCM", "TCM", "TEM", "Precursors", "Effectors", "CD8_TEMRA")

my_cols2 <- c("#204035FF", "#4A7169FF", "#BEB59CFF", "#735231FF", "#49271BFF", "#6C568CFF", "#607345FF", "#E5AD4FFF", "#BD5630FF", "#BFCDD9FF")

names(my_cols2) <- c("D10", "D1", "D2", "D3", "D4", "D5", "D6", "D7", "D8", "D9")

ann <- data.frame(metadata$condition, metadata$donor)
ann[c(1:20, 41:60, 21:40, 61:70),] -> ann
colnames(ann) <- c('CellType', 'DonorID')
colours <- list('CellType' = c("Naive" = "#7F7F7F", "TSCM" = "#548234", "TCM" = "#842121", "TEM" = "#FFA500", "Precursors" = "#00BFC4", "Effectors" = "#F8766D", "CD8_TEMRA" = "#FF00FF"),
  'DonorID' = my_cols2)
colAnn <- HeatmapAnnotation(df = ann,
  which = 'col',
  col = colours,
  annotation_width = unit(c(1, 4), 'cm'),
  gap = unit(1, 'mm'))
```

#generate heatmap after ordering rows and inputting symbols (Figures 1 and 2)
```{r}
log2(counts(run) + 0.5)[ne100, ] -> l2.run.ne100

l2.run.ne100[order(match(rownames(l2.run.ne100), ne100)), , drop = FALSE] -> l2.run.ne100.ordered

l2.run.ne100.ordered[, c(1:20, 41:60, 21:40, 61:70)] -> l2.run.ne100.ordered

l2.run.ne100.ordered %>% as.data.frame() -> l2.run.ne100.ordered.df

l2.run.ne100.ordered.df %>% rownames() -> l2.run.ne100.ordered.df$GENEID
l2.run.ne100.ordered.df %>% head()

merge(l2.run.ne100.ordered.df, geneIDs2.ordered,
                          by = "GENEID", all.x = T) -> l2.run.ne100.ordered.df1

l2.run.ne100.ordered.df1 %>% head()

l2.run.ne100.ordered.df1[!is.na(l2.run.ne100.ordered.df1$SYMBOL),] -> l2.run.ne100.ordered.df1

rownames(l2.run.ne100.ordered.df1) <- l2.run.ne100.ordered.df1$SYMBOL

l2.run.ne100.ordered.df1 %>% head()

l2.run.ne100.ordered.df1[, -c(1, 72)] -> l2.run.ne100.ordered.df2

l2.run.ne100.ordered.df2[order(match(rownames(l2.run.ne100.ordered.df2), top25.symbol)), , drop = FALSE] -> l2.run.ne100.ordered.df2.ordered

l2.run.ne100.ordered.df2.ordered %>% as.matrix() -> l2.run.ne100.ordered.df2.ordered.m

t(scale(t(l2.run.ne100.ordered.df2.ordered.m))) -> l2.run.ne100.ordered.df2.ordered.m

Heatmap(l2.run.ne100.ordered.df2.ordered.m, cluster_columns = FALSE, cluster_rows = T, col = col_fun_rna, row_names_gp = gpar(fontsize = 6), column_names_gp = gpar(fontsize = 6), top_annotation = colAnn) -> p3

pdf(sprintf("%s/NandE.top100.pdf", IMG_OUT), width=10, height=8)
p3
dev.off()
```

#PCA plot for Naive vs Effectors genes (Figure 2)
```{r}
read.csv("../nve_l2fc2_both.txt", header = F) -> nve2
nve2$V1 -> nve2

vsd[nve2, 1:60] -> vsd.nve2

plotPCA(vsd.nve2, ntop = 2722, intgroup = c("condition", "donor"), returnData = TRUE) -> pca.vsd.nve2

levels(pca.vsd.nve2$condition)
pca.vsd.nve2$condition <- factor(pca.vsd.nve2$condition, levels = c("Naive", "TSCM", "TCM", "TEM", "Precursors", "Effectors"))

annotated_pca_plot <- ggplot(
  pca.vsd.nve2,
  aes(
    x = PC1,
    y = PC2)
    
) +
  geom_point(aes(color=condition), size=3)+
  scale_color_manual(values=my_cols1)+
  theme_classic()

# display annotated plot
annotated_pca_plot

pdf(sprintf("%s/samplePCA_NaiveVEff_l2fc2_2722genes.pdf", IMG_OUT), width=10, height=5)
annotated_pca_plot
dev.off()
```

#gsea plots for Celltype1 vs Celltype2 (Figures 1 and 2)
```{r}
#GSEA using DESeq2 results

read.csv("../DE_Celltype1 vs Celltype2.csv", header = T) -> res.c1.c2

c1.v.c2 <- res.c1.c2$log2FoldChange
names(c1.v.c2) <- res.c1.c2$external_gene_name
c1.v.c2 <- na.omit(c1.v.c2)
c1.v.c2 %>% length()
which(duplicated(c1.v.c2)) %>% length()
c1.v.c2 <- c1.v.c2[which(!duplicated(c1.v.c2))]
c1.v.c2 %>% length()
c1.v.c2 <- sort(c1.v.c2, decreasing = T)
c1.v.c2 %>% head()

```

```{r}
cyto.list <- read.csv("../cytotoxicity_rk2.csv", header = T)
```

```{r}
c1.v.c2.gsea <- clusterProfiler::GSEA(geneList = c1.v.c2, TERM2GENE = cyto.list, pvalueCutoff = 1)

gseaplot2(c1.v.c2.gsea, geneSetID = 1:4, pvalue_table = FALSE,
          color = c("#E495A5", "#86B875", "#7DB0DD", "#000000"), ES_geom = "dot",
          title = "CD4-TEMRA-c1ectors vs CD8-TEMRA",
          base_size = 12) -> p6

pdf(sprintf("%s/gsea_4lists_c1.v.c2.pdf", IMG_OUT), width=7, height=6)
p6
dev.off()
```

```{r}
abc <- c1.v.c2.gsea@result
abc$Comparison <- "Celltype1 vs Celltype2"
write.csv(abc, "gsea.results.csv")
```


